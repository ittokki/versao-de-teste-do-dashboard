<!DOCTYPE html>
<html lang="pt-BR" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inimigos da Bola - Ultimate Dashboard</title>
    
    <!-- Bibliotecas Externas -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700&family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">

    <!-- Configurações Tailwind e CSS Personalizado -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        fifa: ['Rajdhani', 'sans-serif'],
                    },
                    colors: {
                        glass: {
                            sidebar: 'rgba(15, 23, 42, 0.95)',
                            panel: 'rgba(30, 41, 59, 0.6)',
                            border: 'rgba(255, 255, 255, 0.1)'
                        }
                    },
                    zIndex: {
                        'modal': '9999',
                        'overlay': '9990'
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background: #0f172a;
            background-image: 
                radial-gradient(at 0% 0%, rgba(56, 189, 248, 0.15) 0px, transparent 50%), 
                radial-gradient(at 100% 0%, rgba(168, 85, 247, 0.15) 0px, transparent 50%);
            color: #e2e8f0;
            overflow: hidden;
        }

        /* Utilitários de Scroll */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.2); }

        /* Vidro */
        .glass-sidebar {
            background: var(--glass-sidebar);
            backdrop-filter: blur(20px);
            border-right: 1px solid rgba(255,255,255,0.05);
        }
        .glass-panel {
            background: rgba(30, 41, 59, 0.4);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255,255,255,0.05);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
        }

        /* Card FIFA */
        .fut-card-container {
            width: 300px; height: 450px; border-radius: 16px; position: relative; overflow: hidden;
            box-shadow: 0 0 30px rgba(0,0,0,0.6);
            background: linear-gradient(135deg, #2e1065 0%, #7e22ce 50%, #a855f7 100%);
            transition: transform 0.3s;
        }
        .fut-card-container:hover { transform: translateY(-5px); }
        .fut-card-container.gold { background: linear-gradient(135deg, #422a02 0%, #ca8a04 50%, #facc15 100%); }
        .fut-card-container.silver { background: linear-gradient(135deg, #1f2937 0%, #6b7280 50%, #e5e7eb 100%); }
        .fut-card-container.special { background: linear-gradient(135deg, #0c4a6e 0%, #0284c7 50%, #38bdf8 100%); }
        .fut-card-shine {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(125deg, transparent 35%, rgba(255,255,255,0.2) 45%, transparent 55%);
            z-index: 2; pointer-events: none;
        }

        /* Navegação */
        .nav-item {
            display: flex; align-items: center; padding: 12px 16px; margin-bottom: 4px;
            border-radius: 8px; color: #94a3b8; transition: all 0.2s; cursor: pointer; border-left: 3px solid transparent;
        }
        .nav-item:hover { background: rgba(255,255,255,0.05); color: #fff; }
        .nav-item.active { background: rgba(59, 130, 246, 0.15); color: #60a5fa; border-left-color: #3b82f6; }

        /* Ranking */
        .rank-item {
            display: flex; align-items: center; padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.05);
            transition: background 0.2s; cursor: pointer;
        }
        .rank-item:hover { background: rgba(255,255,255,0.08); }
        .rank-pos { width: 24px; font-weight: bold; color: #64748b; font-family: 'Rajdhani', sans-serif; font-size: 1.1rem; }
        .rank-1 { color: #fbbf24; text-shadow: 0 0 10px rgba(251, 191, 36, 0.5); }
        .rank-2 { color: #e2e8f0; }
        .rank-3 { color: #b45309; }

        /* Campo */
        .football-pitch {
            background: linear-gradient(to bottom, #064e3b, #065f46);
            border: 4px solid rgba(255,255,255,0.1); position: relative; overflow: hidden;
            box-shadow: inset 0 0 50px rgba(0,0,0,0.5);
        }
        .pitch-line, .pitch-circle, .pitch-area, .pitch-goal { border-color: rgba(255,255,255,0.3); }
        .pitch-line { position: absolute; background: rgba(255,255,255,0.3); }
        .pitch-circle { border: 2px solid; border-radius: 50%; position: absolute; }
        .pitch-area { position: absolute; border: 2px solid; left: 50%; transform: translateX(-50%); width: 40%; height: 15%; }
        .pitch-goal {
            position: absolute; width: 120px; height: 40px; left: 50%; transform: translateX(-50%);
            border: 2px solid; 
            background-image: repeating-linear-gradient(45deg, rgba(255,255,255,0.1) 0, rgba(255,255,255,0.1) 1px, transparent 0, transparent 6px), repeating-linear-gradient(-45deg, rgba(255,255,255,0.1) 0, rgba(255,255,255,0.1) 1px, transparent 0, transparent 6px);
            z-index: 1;
        }

        /* Badges */
        .badge { font-size: 10px; font-weight: bold; padding: 2px 8px; border-radius: 99px; }
        .badge-gol { background: rgba(34, 197, 94, 0.2); color: #4ade80; border: 1px solid rgba(34, 197, 94, 0.3); }
        .badge-ass { background: rgba(59, 130, 246, 0.2); color: #60a5fa; border: 1px solid rgba(59, 130, 246, 0.3); }
        .badge-gk { background: rgba(148, 163, 184, 0.2); color: #e2e8f0; border: 1px solid rgba(148, 163, 184, 0.3); }
        
        .achievement-badge {
            display: inline-flex; align-items: center; padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: bold;
            border: 1px solid rgba(255,255,255,0.1); margin-right: 6px; margin-bottom: 6px; background: rgba(0,0,0,0.3);
        }
        .rarity-mitico { border-color: #a855f7; color: #d8b4fe; box-shadow: 0 0 10px rgba(168, 85, 247, 0.2); }
        .rarity-lendario { border-color: #fbbf24; color: #fcd34d; }
        
        /* Hero Animation */
        @keyframes shine {
            0% { background-position: -200% center; }
            100% { background-position: 200% center; }
        }
        .hero-shine {
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            background-size: 200% 100%;
            animation: shine 3s infinite;
        }

    </style>
</head>
<body class="flex h-screen font-sans text-gray-100">

    <!-- LOADING (Z-INDEX MÁXIMO) -->
    <div id="loading" class="fixed inset-0 bg-[#0f172a] z-[10060] flex flex-col items-center justify-center">
        <div class="w-16 h-16 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mb-4"></div>
        <h2 class="text-2xl font-bold font-fifa tracking-widest text-white animate-pulse">CARREGANDO...</h2>
    </div>

    <!-- SIDEBAR -->
    <aside class="w-64 glass-sidebar flex-shrink-0 flex flex-col h-full z-30 hidden md:flex relative">
        <div class="p-6 flex items-center gap-3 mb-2">
            <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-blue-600 to-blue-800 flex items-center justify-center shadow-lg">
                <i class="fas fa-futbol text-xl text-white"></i>
            </div>
            <div>
                <h1 class="font-fifa font-bold text-2xl leading-none text-white tracking-wide">ULTIMATE</h1>
                <p class="text-[10px] text-blue-400 font-bold tracking-[0.25em] uppercase">Dashboard</p>
            </div>
        </div>

        <nav class="flex-1 px-4 overflow-y-auto custom-scrollbar space-y-1">
            <div class="text-xs font-bold text-gray-500 uppercase px-2 mt-6 mb-2 tracking-wider">Menu Principal</div>
            <div class="nav-item active" data-tab="hub"><i class="fas fa-th-large w-5 mr-3 text-center"></i><span class="text-sm font-semibold">Hub & Rankings</span></div>
            <div class="nav-item" data-tab="team"><i class="fas fa-tshirt w-5 mr-3 text-center"></i><span class="text-sm font-semibold">Seleção</span></div>
            <div class="nav-item" data-tab="draft"><i class="fas fa-users w-5 mr-3 text-center"></i><span class="text-sm font-semibold">Snake Draft</span></div>
            <div class="nav-item" data-tab="stats"><i class="fas fa-chart-pie w-5 mr-3 text-center"></i><span class="text-sm font-semibold">Estatísticas</span></div>
            <div class="nav-item" data-tab="history"><i class="fas fa-history w-5 mr-3 text-center"></i><span class="text-sm font-semibold">Histórico</span></div>
            <div class="nav-item" data-tab="hall"><i class="fas fa-trophy w-5 mr-3 text-center"></i><span class="text-sm font-semibold">Hall da Fama</span></div>

            <div class="text-xs font-bold text-gray-500 uppercase px-2 mt-8 mb-2 tracking-wider">Ferramentas</div>
            <div class="nav-item text-blue-300 hover:text-white" id="btn-compare">
                <i class="fas fa-balance-scale w-5 mr-3 text-center"></i><span class="text-sm font-semibold">Comparar Jogadores</span>
            </div>
            <div class="nav-item text-gray-400 hover:text-white" id="btn-update">
                <i class="fas fa-sync-alt w-5 mr-3 text-center"></i><span class="text-sm font-semibold">Atualizar Dados</span>
            </div>
        </nav>
    </aside>

    <!-- MOBILE HEADER -->
    <div class="md:hidden fixed top-0 left-0 right-0 h-16 glass-sidebar z-40 flex items-center justify-between px-4 border-b border-white/5 backdrop-blur-md">
        <span class="font-fifa font-bold text-xl tracking-wide">ULTIMATE</span>
        <button id="mobile-menu-btn" class="text-white p-2"><i class="fas fa-bars text-xl"></i></button>
    </div>

    <!-- MOBILE MENU OVERLAY (ADICIONADO) -->
    <div id="mobile-menu-overlay" class="fixed inset-0 z-[10070] bg-black/95 backdrop-blur-xl hidden flex-col p-6 transition-opacity duration-300 md:hidden">
        <div class="flex justify-between items-center mb-8">
            <h2 class="text-2xl font-fifa font-bold text-white tracking-widest">MENU</h2>
            <button id="close-mobile-menu" class="text-white/50 hover:text-white text-3xl">&times;</button>
        </div>
        <nav class="flex flex-col gap-4 overflow-y-auto">
            <div class="mobile-nav-item text-xl font-bold text-gray-300 hover:text-white cursor-pointer py-2 border-b border-white/10" data-tab="hub"><i class="fas fa-th-large mr-3 w-6 text-center text-blue-500"></i> Hub & Rankings</div>
            <div class="mobile-nav-item text-xl font-bold text-gray-300 hover:text-white cursor-pointer py-2 border-b border-white/10" data-tab="team"><i class="fas fa-tshirt mr-3 w-6 text-center text-purple-500"></i> Seleção</div>
            <div class="mobile-nav-item text-xl font-bold text-gray-300 hover:text-white cursor-pointer py-2 border-b border-white/10" data-tab="draft"><i class="fas fa-users mr-3 w-6 text-center text-green-500"></i> Snake Draft</div>
            <div class="mobile-nav-item text-xl font-bold text-gray-300 hover:text-white cursor-pointer py-2 border-b border-white/10" data-tab="stats"><i class="fas fa-chart-pie mr-3 w-6 text-center text-yellow-500"></i> Estatísticas</div>
            <div class="mobile-nav-item text-xl font-bold text-gray-300 hover:text-white cursor-pointer py-2 border-b border-white/10" data-tab="history"><i class="fas fa-history mr-3 w-6 text-center text-red-500"></i> Histórico</div>
            <div class="mobile-nav-item text-xl font-bold text-gray-300 hover:text-white cursor-pointer py-2 border-b border-white/10" data-tab="hall"><i class="fas fa-trophy mr-3 w-6 text-center text-yellow-400"></i> Hall da Fama</div>
            
            <div class="text-sm text-gray-500 mt-4 mb-2 uppercase tracking-widest">Ferramentas</div>
            <div class="mobile-nav-item text-lg text-blue-400 hover:text-blue-300 cursor-pointer py-2" id="mob-btn-compare"><i class="fas fa-balance-scale mr-3"></i> Comparar Jogadores</div>
            <div class="mobile-nav-item text-lg text-gray-400 hover:text-white cursor-pointer py-2" id="mob-btn-update"><i class="fas fa-sync-alt mr-3"></i> Atualizar Dados</div>
        </nav>
    </div>

    <!-- MAIN CONTENT -->
    <main class="flex-1 overflow-y-auto h-full relative pt-16 md:pt-0 custom-scrollbar bg-[#0f172a]">
        <div class="p-4 lg:p-8 max-w-[1600px] mx-auto pb-24">

            <!-- FILTER BAR -->
            <div class="glass-panel p-4 rounded-xl mb-8 flex flex-col md:flex-row justify-between items-center gap-4 sticky top-2 z-20 backdrop-blur-xl border border-white/10">
                <div class="relative w-full md:w-96 group">
                    <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-gray-500 group-focus-within:text-blue-400 transition-colors"></i>
                    <input type="text" id="player-search" placeholder="Buscar jogador..." class="w-full bg-black/40 border border-white/10 rounded-lg py-2.5 pl-12 pr-4 text-white focus:outline-none focus:border-blue-500/50 transition-all text-sm font-medium">
                </div>
                <div class="flex items-center gap-3 w-full md:w-auto">
                    <div class="relative w-full md:w-48">
                        <select id="month-filter" class="w-full bg-black/40 border border-white/10 rounded-lg py-2.5 px-4 text-white focus:outline-none cursor-pointer text-sm font-bold appearance-none hover:bg-white/5 transition-colors">
                            <option value="Geral">Temporada Geral</option>
                        </select>
                        <i class="fas fa-chevron-down absolute right-4 top-1/2 -translate-y-1/2 text-gray-500 pointer-events-none text-xs"></i>
                    </div>
                </div>
            </div>

            <!-- TAB: HUB -->
            <div id="hub" class="tab-content opacity-100 transition-opacity duration-300">
                
                <!-- HERO SECTION (MVP) -->
                <div id="hero-section" class="mb-8 glass-panel rounded-2xl overflow-hidden border border-yellow-500/30 relative hidden">
                    <div class="absolute inset-0 bg-gradient-to-r from-purple-900/80 to-blue-900/80 z-0"></div>
                    <div class="absolute inset-0 hero-shine z-0 pointer-events-none"></div>
                    
                    <div class="relative z-10 p-6 md:p-10 flex flex-col md:flex-row items-center justify-between gap-8">
                        <div class="flex flex-col md:flex-row items-center gap-6">
                            <div class="relative">
                                <div class="absolute inset-0 bg-yellow-500 rounded-full blur-xl opacity-30"></div>
                                <img id="hero-img" src="" class="w-32 h-32 md:w-40 md:h-40 rounded-full object-cover border-4 border-yellow-400 shadow-2xl relative z-10">
                                <div class="absolute -bottom-3 left-1/2 -translate-x-1/2 bg-yellow-500 text-black font-bold px-3 py-1 rounded-full text-xs uppercase tracking-wider border-2 border-black z-20 shadow-lg">MVP</div>
                            </div>
                            <div class="text-center md:text-left">
                                <h3 id="hero-label" class="text-yellow-400 font-bold uppercase tracking-[0.2em] text-sm mb-2">MELHOR DA TEMPORADA</h3>
                                <h1 id="hero-name" class="text-4xl md:text-6xl font-black font-fifa text-white uppercase drop-shadow-lg">NOME</h1>
                                <div class="flex items-center justify-center md:justify-start gap-4 mt-2">
                                    <span class="bg-black/40 px-3 py-1 rounded text-sm text-gray-300 border border-white/10"><i class="fas fa-futbol mr-2 text-green-400"></i><span id="hero-goals">0</span> Gols</span>
                                    <span class="bg-black/40 px-3 py-1 rounded text-sm text-gray-300 border border-white/10"><i class="fas fa-shoe-prints mr-2 text-blue-400"></i><span id="hero-assists">0</span> Assist</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-black/30 p-4 rounded-xl border border-white/10 backdrop-blur-md text-center min-w-[150px]">
                            <span class="block text-xs text-gray-400 uppercase tracking-widest mb-1">Nota Média</span>
                            <span id="hero-rating" class="block text-5xl font-bold text-white font-fifa">0.0</span>
                        </div>
                    </div>
                </div>

                <!-- Small Highlights -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <!-- Garçom -->
                    <div class="glass-panel p-5 rounded-xl border-l-4 border-yellow-500 relative overflow-hidden group">
                        <div class="absolute right-0 top-0 p-4 opacity-5 group-hover:opacity-10 transition transform group-hover:scale-110"><i class="fas fa-hands-helping text-7xl"></i></div>
                        <h3 class="text-xs font-bold text-yellow-500 uppercase tracking-widest mb-2">Garçom</h3>
                        <div id="assist-leader-content" class="flex items-center gap-4 relative z-10 min-h-[3rem]"></div>
                    </div>
                    <!-- Paredão -->
                    <div class="glass-panel p-5 rounded-xl border-l-4 border-blue-500 relative overflow-hidden group">
                        <div class="absolute right-0 top-0 p-4 opacity-5 group-hover:opacity-10 transition transform group-hover:scale-110"><i class="fas fa-shield-alt text-7xl"></i></div>
                        <h3 class="text-xs font-bold text-blue-500 uppercase tracking-widest mb-2">Paredão (GK)</h3>
                        <div id="paredao-content" class="flex items-center gap-4 relative z-10 min-h-[3rem]"></div>
                    </div>
                    <!-- Artilheiro -->
                    <div class="glass-panel p-5 rounded-xl border-l-4 border-green-500 relative overflow-hidden group">
                        <div class="absolute right-0 top-0 p-4 opacity-5 group-hover:opacity-10 transition transform group-hover:scale-110"><i class="fas fa-futbol text-7xl"></i></div>
                        <h3 class="text-xs font-bold text-green-500 uppercase tracking-widest mb-2">Artilheiro</h3>
                        <div id="top-scorer-content" class="flex items-center gap-4 relative z-10 min-h-[3rem]"></div>
                    </div>
                </div>

                <h3 class="text-xl font-bold text-white mb-4 flex items-center gap-2 font-fifa"><i class="fas fa-list-ol text-blue-500"></i> RANKINGS OFICIAIS</h3>
                <div id="rankings-grid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6">
                    <!-- Injected via JS -->
                </div>
            </div>

            <!-- TAB: SELEÇÃO -->
            <div id="team" class="tab-content hidden">
                <h2 class="text-3xl font-bold text-white mb-6 flex items-center gap-2 font-fifa">
                    <i class="fas fa-tshirt text-purple-500"></i> SELEÇÃO <span id="team-period-label" class="text-gray-500 text-lg ml-2 font-sans font-normal"></span>
                </h2>
                <div class="football-pitch rounded-xl h-[650px] relative shadow-2xl mx-auto max-w-5xl bg-black/20 backdrop-blur-sm">
                    <div class="pitch-goal top-0 border-t-0 rounded-b-md"></div><div class="pitch-area top-0 border-t-0"></div><div class="pitch-line w-full h-[1px] top-1/2"></div><div class="pitch-circle w-32 h-32 top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2"></div><div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-2 h-2 bg-white/50 rounded-full"></div><div class="pitch-goal bottom-0 border-b-0 rounded-t-md"></div><div class="pitch-area bottom-0 border-b-0"></div>
                    
                    <div id="pitch-players" class="relative w-full h-full z-10"></div>
                </div>
            </div>

            <!-- TAB: DRAFT -->
            <div id="draft" class="tab-content hidden">
                <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                    <div class="lg:col-span-4 glass-panel rounded-xl p-6 h-fit sticky top-24">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-lg font-bold text-white font-fifa uppercase">Convocação</h3>
                            <span id="selected-count" class="bg-blue-500/10 text-blue-400 border border-blue-500/20 text-xs px-2 py-1 rounded font-bold">0 JOG</span>
                        </div>
                        <div class="flex gap-2 mb-4">
                            <button id="select-all" class="flex-1 py-2 text-xs bg-white/5 hover:bg-white/10 border border-white/10 rounded text-gray-300 hover:text-white transition">Todos</button>
                            <button id="clear-all" class="flex-1 py-2 text-xs bg-white/5 hover:bg-red-500/10 border border-white/10 hover:border-red-500/30 rounded text-gray-300 hover:text-red-400 transition">Limpar</button>
                        </div>
                        <div id="draft-list" class="space-y-1 max-h-[500px] overflow-y-auto pr-2 custom-scrollbar"></div>
                        <button id="generate-teams" class="w-full mt-6 bg-gradient-to-r from-blue-600 to-blue-500 hover:from-blue-500 hover:to-blue-400 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-blue-900/20 transition-all transform active:scale-95">
                            <i class="fas fa-random mr-2"></i> GERAR TIMES
                        </button>
                    </div>
                    <div class="lg:col-span-8 space-y-6">
                        <div id="verdict-panel" class="hidden glass-panel rounded-xl p-6 border-l-4 border-purple-500 bg-gradient-to-r from-purple-900/20 to-transparent">
                            <h3 class="text-sm font-bold text-purple-300 mb-2 uppercase tracking-wider"><i class="fas fa-robot mr-2"></i>Veredito da IA</h3>
                            <div id="verdict-text" class="text-gray-200 text-sm leading-relaxed"></div>
                        </div>
                        <div id="teams-container" class="grid grid-cols-1 md:grid-cols-2 gap-6 hidden">
                            <div class="glass-panel rounded-xl p-0 overflow-hidden border border-white/5">
                                <div class="bg-blue-900/30 p-4 border-b border-white/5 flex justify-between items-center">
                                    <h4 class="font-bold text-blue-100 font-fifa text-lg">TIME A</h4>
                                    <span id="stats-team-a" class="text-xs font-mono text-blue-300 bg-blue-900/50 px-2 py-1 rounded"></span>
                                </div>
                                <div id="list-team-a" class="p-4 space-y-2"></div>
                            </div>
                            <div class="glass-panel rounded-xl p-0 overflow-hidden border border-white/5">
                                <div class="bg-red-900/30 p-4 border-b border-white/5 flex justify-between items-center">
                                    <h4 class="font-bold text-red-100 font-fifa text-lg">TIME B</h4>
                                    <span id="stats-team-b" class="text-xs font-mono text-red-300 bg-red-900/50 px-2 py-1 rounded"></span>
                                </div>
                                <div id="list-team-b" class="p-4 space-y-2"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TAB: ESTATÍSTICAS -->
            <div id="stats" class="tab-content hidden">
                <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
                    <div class="glass-panel p-5 rounded-xl h-80 border border-white/5"><canvas id="chart-gols"></canvas></div>
                    <div class="glass-panel p-5 rounded-xl h-80 border border-white/5"><canvas id="chart-assists"></canvas></div>
                    <div class="glass-panel p-5 rounded-xl h-80 border border-white/5"><canvas id="chart-games"></canvas></div>
                    <div class="glass-panel p-5 rounded-xl h-80 xl:col-span-3 border border-white/5"><canvas id="chart-group-goals"></canvas></div>
                </div>
                
                <!-- CURIOSIDADES -->
                <div class="mt-8">
                    <h3 class="text-xl font-bold text-white mb-4 flex items-center gap-2 font-fifa">
                        <i class="fas fa-lightbulb text-yellow-400"></i> CURIOSIDADES
                    </h3>
                    <div id="curiosities-grid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
                        <!-- Injected via JS -->
                    </div>
                </div>
            </div>

            <!-- TAB: HISTÓRICO -->
            <div id="history" class="tab-content hidden">
                <h2 class="text-3xl font-bold text-white mb-6 font-fifa">HISTÓRICO DE PARTIDAS</h2>
                <div id="matches-list" class="space-y-4"></div>
            </div>

            <!-- TAB: HALL -->
            <div id="hall" class="tab-content hidden">
                <h2 class="text-3xl font-bold text-white mb-6 flex items-center gap-3 font-fifa"><i class="fas fa-trophy text-yellow-500"></i> HALL DA FAMA</h2>
                <div id="hall-grid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6"></div>
            </div>

        </div>
    </main>

    <!-- MODAIS (Z-Index Corrigido) -->
    
    <!-- MODAL JOGADOR -->
    <div id="player-modal" class="fixed inset-0 bg-black/95 backdrop-blur-xl z-[10050] hidden items-center justify-center p-4 transition-opacity duration-300">
        <button id="close-player-modal" class="absolute top-6 right-6 text-white/50 hover:text-white text-4xl transition-colors z-50">&times;</button>
        <div class="flex flex-col md:flex-row gap-10 items-center max-w-6xl w-full h-full md:h-auto overflow-y-auto md:overflow-visible">
            <!-- Card Lado Esquerdo -->
            <div class="flex-shrink-0 transform hover:scale-105 transition-transform duration-500">
                <div id="modal-card-container" class="fut-card-container relative group">
                    <div class="fut-card-shine"></div>
                    <div class="absolute top-6 left-6 z-10 text-white drop-shadow-lg">
                        <div class="text-6xl font-bold font-fifa leading-none" id="card-ovr">99</div>
                        <div class="text-2xl font-bold uppercase tracking-wide opacity-90" id="card-pos">ATA</div>
                    </div>
                    <div class="absolute top-14 left-1/2 -translate-x-1/2 w-44 h-44 rounded-full border-4 border-black/20 overflow-hidden shadow-2xl z-10 bg-black/20">
                        <img id="card-img" src="" class="w-full h-full object-cover">
                    </div>
                    <div class="absolute top-60 w-full text-center z-10 px-4">
                        <div class="font-fifa font-bold text-3xl text-white uppercase tracking-wider drop-shadow-[0_2px_2px_rgba(0,0,0,0.8)]" id="card-name">NOME</div>
                        <div class="w-16 h-1 bg-white/40 mx-auto mt-2 rounded-full"></div>
                    </div>
                    <div class="absolute bottom-8 left-0 w-full px-8 grid grid-cols-2 gap-y-2 gap-x-6 text-white font-fifa font-bold text-lg z-10">
                        <div class="flex justify-between border-b border-white/20 pb-1"><span id="stat-pac">00</span><span class="text-sm opacity-80">PAC</span></div>
                        <div class="flex justify-between border-b border-white/20 pb-1"><span id="stat-sho">00</span><span class="text-sm opacity-80">SHO</span></div>
                        <div class="flex justify-between border-b border-white/20 pb-1"><span id="stat-pas">00</span><span class="text-sm opacity-80">PAS</span></div>
                        <div class="flex justify-between border-b border-white/20 pb-1"><span id="stat-def">00</span><span class="text-sm opacity-80">DEF</span></div>
                        <div class="flex justify-between border-b border-white/20 pb-1"><span id="stat-phy">00</span><span class="text-sm opacity-80">PHY</span></div>
                        <div class="flex justify-between border-b border-white/20 pb-1"><span id="stat-jog">00</span><span class="text-sm text-yellow-300">JOG</span></div>
                    </div>
                </div>
            </div>
            
            <!-- Detalhes Lado Direito -->
            <div class="flex-1 w-full text-white overflow-y-auto max-h-[80vh] custom-scrollbar pr-4">
                <div class="flex items-end gap-4 mb-6 border-b border-white/10 pb-4">
                    <h2 class="text-5xl font-bold uppercase font-fifa" id="detail-name">Nome</h2>
                    <span class="px-3 py-1 mb-2 rounded bg-blue-600/80 text-sm font-bold uppercase tracking-wider border border-blue-400/30" id="detail-level">Lenda</span>
                </div>

                <!-- Big Stats -->
                <div class="grid grid-cols-4 gap-4 mb-8">
                    <div class="bg-white/5 border border-white/10 rounded-xl p-4 text-center">
                        <span class="block text-[10px] text-gray-400 uppercase tracking-widest mb-1">NOTA MÉDIA</span>
                        <span class="block text-3xl font-bold text-blue-400 font-fifa" id="detail-media">0.0</span>
                    </div>
                    <div class="bg-white/5 border border-white/10 rounded-xl p-4 text-center">
                        <span class="block text-[10px] text-gray-400 uppercase tracking-widest mb-1">GOLS</span>
                        <span class="block text-3xl font-bold text-green-400 font-fifa" id="detail-gols">0</span>
                    </div>
                    <div class="bg-white/5 border border-white/10 rounded-xl p-4 text-center">
                        <span class="block text-[10px] text-gray-400 uppercase tracking-widest mb-1">ASSIST</span>
                        <span class="block text-3xl font-bold text-yellow-400 font-fifa" id="detail-assist">0</span>
                    </div>
                    <div class="bg-white/5 border border-white/10 rounded-xl p-4 text-center">
                        <span class="block text-[10px] text-gray-400 uppercase tracking-widest mb-1">VITÓRIAS</span>
                        <span class="block text-3xl font-bold text-purple-400 font-fifa" id="detail-wins">0</span>
                    </div>
                </div>

                <!-- Chart -->
                <div class="glass-panel p-4 rounded-xl mb-6 border border-white/5">
                    <h4 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-4">Evolução de Performance</h4>
                    <div class="h-40 w-full"><canvas id="player-evo-chart"></canvas></div>
                </div>

                <!-- Badges -->
                <div class="mb-6">
                    <h3 class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-3">Sala de Troféus</h3>
                    <div id="detail-badges" class="flex flex-wrap gap-2"></div>
                </div>

                <!-- Histórico -->
                <div>
                    <h3 class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-3">Histórico Recente</h3>
                    <div class="space-y-2" id="detail-history"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL PARTIDA -->
    <div id="match-modal" class="fixed inset-0 bg-black/95 backdrop-blur-xl z-[10000] hidden items-center justify-center p-4">
        <button id="close-match-modal" class="absolute top-6 right-6 text-white/50 hover:text-white text-4xl transition-colors z-50">&times;</button>
        <div class="glass-panel w-full max-w-7xl h-[90vh] rounded-2xl flex flex-col overflow-hidden border border-white/10 box-shadow-2xl">
            <!-- Header -->
            <div class="bg-black/40 p-6 text-center border-b border-white/10 relative">
                <h2 class="text-xs font-bold text-gray-400 uppercase tracking-[0.3em] mb-6" id="match-date">RESUMO DA PARTIDA</h2>
                <div class="flex items-center justify-center gap-8 md:gap-24">
                    <div class="text-right">
                        <h1 class="text-5xl md:text-7xl font-bold text-blue-500 font-fifa drop-shadow-lg">BOCA</h1>
                        <span class="text-[10px] text-gray-500 uppercase tracking-widest">MANDANTE</span>
                    </div>
                    <div class="text-6xl md:text-8xl font-bold text-white flex items-center gap-6 bg-black/40 px-8 py-2 rounded-2xl border border-white/5 shadow-2xl">
                        <span id="score-a">0</span>
                        <span class="text-gray-600 text-4xl">-</span>
                        <span id="score-b">0</span>
                    </div>
                    <div class="text-left">
                        <h1 class="text-5xl md:text-7xl font-bold text-red-500 font-fifa drop-shadow-lg">RIVER</h1>
                        <span class="text-[10px] text-gray-500 uppercase tracking-widest">VISITANTE</span>
                    </div>
                </div>
            </div>
            <!-- Content -->
            <div class="flex-1 overflow-hidden flex flex-col md:flex-row">
                <div class="w-full md:w-1/3 p-6 overflow-y-auto border-r border-white/5 bg-black/20 custom-scrollbar">
                    <div class="mb-8">
                        <div class="flex items-center gap-3 mb-4 pb-2 border-b border-blue-500/30">
                            <div class="w-2 h-2 bg-blue-500 rounded-full shadow-[0_0_10px_blue]"></div>
                            <h3 class="text-blue-400 font-bold uppercase text-sm tracking-wider">Elenco Boca</h3>
                        </div>
                        <div id="list-boca" class="space-y-2"></div>
                    </div>
                    <div>
                        <div class="flex items-center gap-3 mb-4 pb-2 border-b border-red-500/30">
                            <div class="w-2 h-2 bg-red-500 rounded-full shadow-[0_0_10px_red]"></div>
                            <h3 class="text-red-400 font-bold uppercase text-sm tracking-wider">Elenco River</h3>
                        </div>
                        <div id="list-river" class="space-y-2"></div>
                    </div>
                </div>
                <div class="w-full md:w-2/3 p-8 relative bg-[#0f172a] flex flex-col">
                    <div class="text-center mb-4"><h3 class="text-yellow-400 font-bold uppercase tracking-widest text-sm flex items-center justify-center gap-2"><i class="fas fa-star"></i> SELEÇÃO DO JOGO</h3></div>
                    <div class="flex-1 flex items-center justify-center">
                        <div class="football-pitch rounded-xl w-full max-w-3xl h-[500px] relative shadow-2xl border-2 border-white/10" id="match-pitch">
                            <div class="pitch-goal top-0 border-t-0 rounded-b-md"></div><div class="pitch-area top-0 border-t-0"></div><div class="pitch-line w-full h-[1px] top-1/2"></div><div class="pitch-circle w-24 h-24 top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2"></div><div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-2 h-2 bg-white/50 rounded-full"></div><div class="pitch-goal bottom-0 border-b-0 rounded-t-md"></div><div class="pitch-area bottom-0 border-b-0"></div>
                            <div id="match-team-display" class="relative w-full h-full z-10"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL COMPARADOR -->
    <div id="comparison-modal" class="fixed inset-0 bg-black/95 backdrop-blur-xl z-[10000] hidden items-center justify-center p-4">
        <button id="close-comparison-modal" class="absolute top-6 right-6 text-white/50 hover:text-white text-4xl transition-colors z-50">&times;</button>
        <div class="glass-panel w-full max-w-5xl rounded-2xl p-8 flex flex-col h-[90vh] overflow-y-auto custom-scrollbar border border-white/10">
            <h2 class="text-3xl font-bold text-white mb-8 text-center font-fifa uppercase tracking-widest">Face-a-Face</h2>
            
            <!-- Selectors -->
            <div class="flex flex-col md:flex-row justify-center items-center gap-8 mb-8">
                <div class="w-full md:w-64">
                    <label class="block text-xs text-blue-400 font-bold uppercase mb-2">Jogador 1</label>
                    <select id="p1-select" class="w-full bg-black/40 text-white p-3 rounded-lg border border-blue-500/30 focus:outline-none focus:border-blue-500 transition"></select>
                </div>
                <div class="text-4xl font-bold text-white font-fifa opacity-50">VS</div>
                <div class="w-full md:w-64">
                    <label class="block text-xs text-red-400 font-bold uppercase mb-2">Jogador 2</label>
                    <select id="p2-select" class="w-full bg-black/40 text-white p-3 rounded-lg border border-red-500/30 focus:outline-none focus:border-red-500 transition"></select>
                </div>
            </div>

            <!-- Content -->
            <div id="comparison-content" class="grid grid-cols-1 md:grid-cols-3 gap-8 items-start flex-1">
                <div class="text-center col-span-3 text-gray-500 py-10">Selecione dois jogadores para iniciar o duelo.</div>
            </div>
            
            <!-- Radar Chart Container (Hidden initially) -->
            <div id="radar-container" class="hidden mt-8 justify-center">
                <div class="w-full max-w-md h-[300px] relative">
                    <canvas id="radar-chart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL RANKING COMPLETO -->
    <div id="full-list-modal" class="fixed inset-0 bg-black/90 backdrop-blur-sm z-[9990] hidden items-center justify-center p-4">
        <div class="glass-panel w-full max-w-xl h-[80vh] rounded-xl flex flex-col border border-white/10">
            <div class="p-4 border-b border-white/10 flex justify-between items-center bg-white/5">
                <h3 class="text-lg font-bold text-white font-fifa uppercase tracking-wider" id="full-list-title">Ranking</h3>
                <button id="close-full-list" class="text-gray-400 hover:text-white text-2xl transition">&times;</button>
            </div>
            <div class="flex-1 overflow-y-auto p-0 custom-scrollbar" id="full-list-content"></div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const apiKey = "AIzaSyCL19ds6YqVOv5vV-zygBjeC-byy-rDPfM";
    const spreadsheetId = "1TvrVT8ksYYMlpw8gkKIFvpnnCf02J8uYTkhHc5c0vdo";
    const rangePagina1 = "Página1!A2:H100";
    const rangePagina2 = "Página2!A2:L300";
    
    const clickSoundUrl = "https://raw.githubusercontent.com/ittokki/Futebol/main/PES%202013%20Select%20Game%20Main%20Menu%20Sound%20Effect%20(mp3cut.net).mp3";
    const clickAudio = new Audio(clickSoundUrl);
    clickAudio.volume = 0.5; // Adjust volume

    document.addEventListener('click', () => {
        // Clone node or reset time to allow rapid fire clicks
        const sound = clickAudio.cloneNode();
        sound.volume = 0.3; 
        sound.play().catch(e => console.warn("Sound blocked", e));
    });
    
    const playerPhotos = {
        "ADEMIR": "https://drive.google.com/thumbnail?id=19uLFnCc6T_EWK0Z2R1Nfw7Mi10a3LIdQ&sz=w500",
        "ALESSANDRO": "https://drive.google.com/thumbnail?id=1eGjTXt1wcG8aqEphPjZZMo2DGSAVTA2h&sz=w500",
        "ANDRIUS": "https://drive.google.com/thumbnail?id=1lBPpJryy0nosPEAJpwu-na-YfSfju_Hn&sz=w500",
        "BRUNO GUIMARAES": "https://drive.google.com/thumbnail?id=14WYCQ1C11-1VXMc5gXMrVkJAZKHkMy30&sz=w500",
        "CARLOS ALEXANDRE": "https://drive.google.com/thumbnail?id=1-lm5HqA2V_kRD9ETFY4jvLfwpCEzbcKM&sz=w500",
        "CHRISTIANO": "https://drive.google.com/thumbnail?id=1jh9wzyW-lIg9L9b-3qbBJfEVMnaA7Fny&sz=w500",
        "DOUGLAS DAITX": "https://drive.google.com/thumbnail?id=1kv305jEIO7C2u0x66lLQomZE1ECUR6Nk&sz=w500",
        "EDUARDO DUDU": "https://drive.google.com/thumbnail?id=1ieo-vpgcjWz3MaGA8hs5L0MxqJtxQDaq&sz=w500",
        "EVERTON": "https://drive.google.com/thumbnail?id=1gw-zhOl9_EwVAHq63wd1zaodD6PWhagG&sz=w500",
        "FRANCISCO CHICO": "https://drive.google.com/thumbnail?id=1cyklLvwHfJAsNz8aXJpNrrXfMcZY_Not&sz=w500",
        "GUSTAVO": "https://drive.google.com/thumbnail?id=1lYYKBFNSdxP3_azDHHiewLXQ6gHCzWNj&sz=w500",
        "HENRIQUE AMARAL": "https://drive.google.com/thumbnail?id=1V7_e555JZ9DlUtJXl-Q94_TxnRpyRS26&sz=w500",
        "HENRIQUE SILVA": "https://drive.google.com/thumbnail?id=1YMVMfLNkMG0hg1YjfmmFIa-4OvJuGIzk&sz=w500",
        "IAGO NUNES": "https://drive.google.com/thumbnail?id=19BAt94_apJXVWI1rnpNPfLnXG_dzr2IZ&sz=w500",
        "JUAREZ CARDOSO": "https://drive.google.com/thumbnail?id=1ylBwDdDDa6ZVXNS_gjNW0U5Hu2bDErHk&sz=w500",
        "LUCAS HENRIQUE": "https://drive.google.com/thumbnail?id=1RFSypiSjWo01lSXNh4YWsLUHMi0QhXz4&sz=w500",
        "LUCAS ZUCHI": "https://drive.google.com/thumbnail?id=1uahzfKtDDqK4s4lB2vrr3beYKN1Zx0AH&sz=w500",
        "MAICON": "https://drive.google.com/thumbnail?id=1dDxjhc3GHOu7YrCkX8EyxTC4A_x74Xnt&sz=w500",
        "MARCO DAITX": "https://drive.google.com/thumbnail?id=1kR_hlxSyD2HG_fdyNefcKIQFHkXXFFNG&sz=w500",
        "MATHEUS": "https://drive.google.com/thumbnail?id=1MyGNbFiF7uHhgIP2I7FqYgrizuxeR6aX&sz=w500",
        "PEDRALLI": "https://drive.google.com/thumbnail?id=1oxuryNnAVqHfU1u4Mg1lZ9YtUOKvkIK_&sz=w500",
        "THALES RAMOS": "https://drive.google.com/thumbnail?id=1lQQ5tWG1rMaQJj0ogkNUqyz1si5GwfkA&sz=w500",
        "VICTOR MATHEUS": "https://drive.google.com/thumbnail?id=1c3Cq36Bw2KCqpFCz6vwRr9gJ344gK4bo&sz=w500",
        "VITOR (GOL)": "https://drive.google.com/thumbnail?id=1iEwFEzr04iMtcJhd0a_jt_Th6Ca4pjEe&sz=w500",
        "WILIAN": "https://drive.google.com/thumbnail?id=1Pe30oPHtNC54iOzX1nrhdAbQQwWg2L5P&sz=w500",
        "WILLY": "https://drive.google.com/thumbnail?id=1epf6bJAQomcxDOtcdbGDLQDOM20x199j&sz=w500",
        "ZECA": "https://drive.google.com/thumbnail?id=1nijIMeVwsl9ApSSeu47QnK612JJXGYSL&sz=w500"
    };

    let allPlayersData = [];
    let allMatchesData = [];
    let chartInstances = {};

    // --- HELPERS ---
    const parseNum = (val) => typeof val === "number" ? val : (Number(val?.toString().replace(',', '.').trim()) || 0);
    const normalizaNome = (nome) => nome ? nome.normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/\s+/g, " ").replace(/\(GOL\)/gi, "").trim().toUpperCase() : '';
    const mapPosition = (pos) => {
        if (!pos) return 'N/A';
        const p = pos.toLowerCase();
        if (p.includes('ata')) return 'ata'; if (p.includes('mei')) return 'mei'; if (p.includes('ala')) return 'ala'; if (p.includes('zag')) return 'zag'; if (p.includes('gol')) return 'gol';
        return 'N/A';
    };

    // --- CALCULOS ---
    function calculateFIFAStats(player) {
        // 1. OVR (Overall): CURVA AJUSTADA (Mais rigorosa)
        let ovr;
        
        // Jogadores com nota boa (>= 6.0)
        // Nota 6.0 = 70 (Baixei de 75 para 70 para valorizar mais os 80+)
        // Nota 10.0 = 98
        if (player.notaGeral >= 6) {
            ovr = 70 + (player.notaGeral - 6) * 7; 
        } 
        // Jogadores com nota abaixo da média (< 6.0)
        // Curva mais íngreme para diferenciar "quase lá" de "jogou mal"
        // Nota 5.78 vai dar aprox 68/69
        else {
            ovr = 35 + (player.notaGeral * 5.8);
        }
        
        // Penalidade para novatos (menos de 3 jogos)
        if (player.jogos < 3) ovr = Math.min(ovr, 68);
        
        ovr = Math.round(ovr);

        // 2. Estatísticas Dinâmicas
        const gpg = player.gols / (player.jogos || 1); 
        const apg = player.assistencias / (player.jogos || 1);
        const pos = player.posicaoPref;

        // Base dos atributos um pouco abaixo do OVR para dar espaço aos boosts
        let base = ovr - 12; 

        let pac = base;
        let sho = base;
        let pas = base;
        let def = base;
        let phy = base;

        // 3. Especialização por Posição (Boosts ajustados para o novo OVR)
        
        // RITMO (PAC)
        if (['ata', 'ala'].includes(pos)) pac = ovr - 3; 
        else if (pos === 'mei') pac = ovr - 12;
        else pac = ovr - 15; 
        
        // CHUTE (SHO)
        let shoBonus = (gpg * 25); 
        if (pos === 'ata') sho = (ovr - 6) + shoBonus;
        else if (pos === 'mei' || pos === 'ala') sho = (ovr - 15) + shoBonus;
        else sho = (ovr - 35) + shoBonus;

        // PASSE (PAS)
        let pasBonus = (apg * 30);
        if (['mei', 'ala'].includes(pos)) pas = (ovr - 5) + pasBonus;
        else if (pos === 'ata') pas = (ovr - 18) + pasBonus;
        else pas = (ovr - 22) + pasBonus;

        // DEFESA (DEF)
        if (['zag', 'gol'].includes(pos)) def = ovr - 3;
        else if (['ala', 'mei'].includes(pos)) def = ovr - 22;
        else def = ovr - 45;

        // FÍSICO (PHY)
        let phyBonus = Math.min(8, player.jogos / 2);
        if (['zag', 'gol'].includes(pos)) phy = (ovr - 5) + phyBonus;
        else phy = (ovr - 18) + phyBonus;

        // 4. CORREÇÃO DE COERÊNCIA (Boost final para o atributo principal não ficar lixo)
        const boost = (val, target) => Math.max(val, target);

        if(pos === 'ata') {
            sho = boost(sho, ovr - 2);
            pac = boost(pac, ovr - 5);
        } else if (pos === 'ala') {
            pac = boost(pac, ovr - 2);
            pas = boost(pas, ovr - 6);
        } else if (pos === 'mei') {
            pas = boost(pas, ovr - 2);
            sho = boost(sho, ovr - 10); 
        } else if (pos === 'zag') {
            def = boost(def, ovr - 2);
            phy = boost(phy, ovr - 4);
        } else if (pos === 'gol') {
            def = boost(def, ovr - 1); 
            phy = boost(phy, ovr - 3); 
        }

        // Clamping
        const clamp = (n) => Math.max(25, Math.min(99, Math.round(n)));

        // Definir Raridade (Ajustada para a nova escala)
        let type = 'card-silver';
        let cssClass = 'silver';
        if (ovr >= 90) { type = 'card-mitico'; cssClass = 'special'; } 
        else if (ovr >= 85) { type = 'card-special'; cssClass = 'special'; } 
        else if (ovr >= 75) { type = 'card-gold'; cssClass = 'gold'; } // Ouro agora só acima de 75
        else if (ovr >= 65) { type = 'card-silver'; cssClass = 'silver'; } // Prata 65-74
        else { type = 'card-bronze'; cssClass = 'silver'; } // Bronze < 65

        return { 
            ovr: clamp(ovr), 
            pac: clamp(pac), 
            sho: clamp(sho), 
            pas: clamp(pas), 
            def: clamp(def), 
            phy: clamp(phy),
            type: type,
            cssClass: cssClass
        };
    }

    function calculateConquistas(jogador, partidas) {
        const conquistas = [];
        partidas.forEach(p => {
            if (p.gols >= 5) conquistas.push({ nome: "Repoker", desc: "5 Gols", icon: "fa-star", rarity: "lendario" });
            else if (p.gols >= 4) conquistas.push({ nome: "Poker", desc: "4 Gols", icon: "fa-dice-four", rarity: "epico" });
            else if (p.gols >= 3) conquistas.push({ nome: "Hat-Trick", desc: "3 Gols", icon: "fa-futbol", rarity: "raro" });
            if (p.assistencias >= 4) conquistas.push({ nome: "Maestro", desc: "4 Assist", icon: "fa-wand-magic-sparkles", rarity: "lendario" });
            if (p.notaPartida >= 9.5) conquistas.push({ nome: "Lenda", desc: "Nota 9.5+", icon: "fa-crown", rarity: "mitico" });
        });
        if (jogador.jogos >= 50) conquistas.push({ nome: "Veterano", desc: "50 Jogos", icon: "fa-shield-halved", rarity: "lendario" });
        return conquistas;
    }

    // CORREÇÃO AQUI: Lógica de contagem respeitando a formação tática
    function calculateSelectionCount(matches) {
        const dates = [...new Set(matches.filter(m => m.jogoAconteceu).map(m => m.dataJogo))];
        const counts = {};

        dates.forEach(date => {
            const dayMatches = matches.filter(m => m.dataJogo === date && m.jogoAconteceu);

            // Função auxiliar para pegar os N melhores daquela posição naquele dia
            const getBestOfPos = (pos, limit) => {
                return dayMatches
                    .filter(p => p.posicao === pos)
                    .sort((a, b) => b.notaPartida - a.notaPartida)
                    .slice(0, limit);
            };

            // Seleciona o time ideal do dia respeitando: 1 GOL, 1 ZAG, 2 ALA, 1 MEI, 2 ATA
            const selectionOfDay = [
                ...getBestOfPos('gol', 1),
                ...getBestOfPos('zag', 1),
                ...getBestOfPos('ala', 2),
                ...getBestOfPos('mei', 1),
                ...getBestOfPos('ata', 2)
            ];

            // Só incrementa a contagem se o jogador entrou nessa lista seleta
            selectionOfDay.forEach(p => {
                counts[p.nome] = (counts[p.nome] || 0) + 1;
            });
        });

        return counts;
    }

    function processDataForPeriod(matches, playersRaw) {
        const selectionCounts = calculateSelectionCount(matches);
        const periodPlayers = new Map();
        playersRaw.forEach(r => {
            const n = normalizaNome(r[1]);
            if(n) periodPlayers.set(n, { nome: n, nomeOriginal: r[1], stats: { jogos:0, gols:0, ass:0, notas:[], posicoes:[], jogosGol:0, golsTomados:0, vitorias:0 } });
        });
        matches.forEach(m => {
            if(m.jogoAconteceu && periodPlayers.has(m.nome)) {
                const p = periodPlayers.get(m.nome);
                p.stats.jogos++; p.stats.gols += m.gols; p.stats.ass += m.assistencias;
                p.stats.notas.push(m.notaPartida); p.stats.posicoes.push(m.posicao);
                p.stats.vitorias += (m.vitoria === 1 ? 1 : 0);
                if(m.isGoleiro) { p.stats.jogosGol++; p.stats.golsTomados += m.golsTomados; }
                if(!p.partidas) p.partidas = [];
                p.partidas.push(m);
            }
        });
        return Array.from(periodPlayers.values()).map(p => {
            const notaGeral = p.stats.notas.length ? p.stats.notas.reduce((a,b)=>a+b,0)/p.stats.notas.length : 0;
            const posCount = p.stats.posicoes.reduce((acc, pos) => { acc[pos] = (acc[pos] || 0) + 1; return acc; }, {});
            const primaryPos = Object.keys(posCount).sort((a, b) => posCount[b] - posCount[a])[0] || 'N/A';
            const obj = {
                nome: p.nome, nomeOriginal: p.nomeOriginal,
                jogos: p.stats.jogos, gols: p.stats.gols, assistencias: p.stats.ass, vitorias: p.stats.vitorias,
                notaGeral: notaGeral, posicaoPref: primaryPos, partidas: p.partidas || [],
                mediaGolsSofridos: p.stats.jogosGol > 0 ? (p.stats.golsTomados / p.stats.jogosGol) : null,
                jogosGoleiro: p.stats.jogosGol,
                ga: p.stats.gols + p.stats.ass,
                aproveitamento: p.stats.jogos > 0 ? (p.stats.vitorias / p.stats.jogos) * 100 : 0,
                selectionCount: selectionCounts[p.nome] || 0,
                nivel: notaGeral >= 9 ? 'Lenda' : notaGeral >= 8 ? 'Craque' : notaGeral >= 7 ? 'Diferenciado' : notaGeral >= 6 ? 'Esforçado' : 'Iniciante'
            };
            obj.fifa = calculateFIFAStats(obj);
            obj.conquistas = calculateConquistas(obj, obj.partidas);
            return obj;
        }).filter(p => p.jogos > 0);
    }

    // --- DATA FETCH ---
    async function initData() {
        try {
            const fetchSheet = async (rng) => {
                const res = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${rng}?key=${apiKey}`);
                return (await res.json()).values || [];
            };
            const [partidasRaw, jogadoresRaw] = await Promise.all([fetchSheet(rangePagina2), fetchSheet(rangePagina1)]);

            allMatchesData = partidasRaw.map(row => ({
                nome: normalizaNome(row[0]), nomeRaw: row[0],
                gols: parseNum(row[1]), assistencias: parseNum(row[2]),
                golsTomados: parseNum(row[3]), golsContra: parseNum(row[4]),
                notaADM: parseNum(row[5]), dataJogo: row[6],
                vitoria: (row[7]||"").toLowerCase().trim() === 'sim' ? 1 : (row[7]||"").toLowerCase().trim() === 'empate' ? 0.5 : 0,
                time: row[8] || 'N/A',
                jogoAconteceu: (row[10] || "").toLowerCase() === 'sim',
                isGoleiro: (row[0] || "").toUpperCase().includes('(GOL)') || parseNum(row[3]) > 0,
                posicao: mapPosition(row[11])
            })).filter(p => p.nome && /^\d{2}\/\d{2}\/\d{4}$/.test(p.dataJogo));

            allMatchesData.forEach(p => {
                if(p.jogoAconteceu) {
                    const base = 6.0 + (p.gols * 0.7) + (p.assistencias * 0.6) + (p.isGoleiro ? p.golsTomados * -0.15 : 0) + (p.golsContra * -0.7);
                    let ponderada = (base + (p.notaADM * 5)) / 6;
                    p.notaPartida = Math.max(0, Math.min(10, ponderada + (p.vitoria === 1 ? 0.3 : p.vitoria === 0.5 ? 0.15 : 0)));
                } else p.notaPartida = 0;
            });

            const months = [...new Set(allMatchesData.map(m => m.dataJogo.substring(3)))];
            const filter = document.getElementById('month-filter');
            months.sort((a,b) => new Date(b.split('/').reverse().join('-')) - new Date(a.split('/').reverse().join('-'))).forEach(m => {
                const [mm, yyyy] = m.split('/');
                const date = new Date(yyyy, mm-1);
                const name = date.toLocaleString('pt-BR', { month: 'long', year: 'numeric' });
                filter.innerHTML += `<option value="${m}">${name.charAt(0).toUpperCase() + name.slice(1)}</option>`;
            });

            allPlayersData = processDataForPeriod(allMatchesData, jogadoresRaw);
            
            filter.addEventListener('change', () => {
                const val = filter.value;
                const filteredMatches = val === 'Geral' ? allMatchesData : allMatchesData.filter(m => m.dataJogo.substring(3) === val);
                const filteredPlayers = processDataForPeriod(filteredMatches, jogadoresRaw);
                updateDashboard(filteredPlayers, filteredMatches);
            });

            setupEventListeners(); // BIND EVENTS ONCE
            updateDashboard(allPlayersData, allMatchesData);
            document.getElementById('loading').style.display = 'none';

        } catch (e) {
            console.error(e);
            document.getElementById('loading').innerHTML = `<p class="text-red-500">Erro: ${e.message}</p>`;
        }
    }

    // --- EVENT LISTENERS CENTRALIZADOS ---
    function setupEventListeners() {
        // Tabs
        document.querySelectorAll('.nav-item').forEach(btn => {
            btn.addEventListener('click', () => {
                if(btn.id === 'update-btn') { location.reload(); return; }
                if(btn.id === 'btn-compare') {
                    const modal = document.getElementById('comparison-modal');
                    modal.classList.remove('hidden'); modal.classList.add('flex');
                    setupComparisonTool(); // Init selects only when opened
                    return;
                }
                if(btn.id === 'btn-update') { location.reload(); return; }

                document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
                // Handle opacity transition manually for smoother feel
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('opacity-100'));
                
                btn.classList.add('active');
                const target = document.getElementById(btn.dataset.tab);
                target.classList.remove('hidden');
                setTimeout(()=> target.classList.add('opacity-100'), 10);
            });
        });

        // Mobile Menu (NOVA LÓGICA)
        const mobileMenuBtn = document.getElementById('mobile-menu-btn');
        const mobileMenu = document.getElementById('mobile-menu-overlay');
        const closeMobileMenu = document.getElementById('close-mobile-menu');

        mobileMenuBtn.addEventListener('click', () => {
            mobileMenu.classList.remove('hidden');
            mobileMenu.classList.add('flex');
        });

        closeMobileMenu.addEventListener('click', () => {
            mobileMenu.classList.add('hidden');
            mobileMenu.classList.remove('flex');
        });

        // Mobile Nav Items Logic (similar to desktop)
        document.querySelectorAll('.mobile-nav-item').forEach(btn => {
            btn.addEventListener('click', () => {
                mobileMenu.classList.add('hidden');
                mobileMenu.classList.remove('flex');

                if(btn.id === 'mob-btn-update') { location.reload(); return; }
                if(btn.id === 'mob-btn-compare') {
                    const modal = document.getElementById('comparison-modal');
                    modal.classList.remove('hidden'); modal.classList.add('flex');
                    setupComparisonTool();
                    return;
                }

                const tabId = btn.dataset.tab;
                if(tabId) {
                    // Update desktop nav state too just in case
                    document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
                    const desktopBtn = document.querySelector(`.nav-item[data-tab="${tabId}"]`);
                    if(desktopBtn) desktopBtn.classList.add('active');

                    // Switch Tab
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('opacity-100'));
                    
                    const target = document.getElementById(tabId);
                    target.classList.remove('hidden');
                    setTimeout(()=> target.classList.add('opacity-100'), 10);
                }
            });
        });

        // Modal Closers
        const close = (id) => {
            const el = document.getElementById(id);
            el.classList.add('hidden'); el.classList.remove('flex');
        };
        document.getElementById('close-player-modal').onclick = () => close('player-modal');
        document.getElementById('close-match-modal').onclick = () => close('match-modal');
        document.getElementById('close-comparison-modal').onclick = () => close('comparison-modal');
        document.getElementById('close-full-list').onclick = () => close('full-list-modal');

        // Search
        document.getElementById('player-search').addEventListener('input', () => {
            renderRankings(allPlayersData); // Only re-render rankings on search to be fast
        });

        // Draft
        document.getElementById('select-all').onclick = () => {
            document.querySelectorAll('.draft-chk').forEach(c => { c.checked = true; c.closest('div').classList.add('bg-blue-500/20'); });
        };
        document.getElementById('clear-all').onclick = () => {
            document.querySelectorAll('.draft-chk').forEach(c => { c.checked = false; c.closest('div').classList.remove('bg-blue-500/20'); });
        };
        document.getElementById('generate-teams').onclick = generateTeams;
    }

    function updateDashboard(players, matches) {
        renderHero(players); // New Hero
        renderRankings(players);
        renderSpecialRankings(players, matches);
        renderSelectionField(players);
        renderDraftList(players);
        renderHistory(matches);
        renderHall(players);
        renderStatsCharts(players, matches);
        renderFunFacts(players, matches); // Added back
    }

    // --- HERO SECTION ---
    function renderHero(players) {
        if(!players.length) return;

        const filterVal = document.getElementById('month-filter').value;
        let candidates = players;

        // Se for filtro mensal, exige mínimo de 2 jogos
        if (filterVal !== 'Geral') {
            const filtered = players.filter(p => p.jogos >= 2);
            // Só aplica o filtro se houver jogadores elegíveis, senão mantém todos (fallback para início de mês)
            if (filtered.length > 0) {
                candidates = filtered;
            }
        }

        const hero = candidates.sort((a,b) => b.notaGeral - a.notaGeral)[0]; // Best by rating
        const container = document.getElementById('hero-section');
        container.classList.remove('hidden');

        // Dynamic Label
        const label = filterVal === 'Geral' ? "MELHOR DA TEMPORADA" : `MELHOR DE ${document.getElementById('month-filter').options[document.getElementById('month-filter').selectedIndex].text.toUpperCase()}`;
        
        document.getElementById('hero-label').innerText = label;
        document.getElementById('hero-name').innerText = hero.nomeOriginal.split(' ')[0];
        document.getElementById('hero-img').src = playerPhotos[hero.nome] || `https://ui-avatars.com/api/?name=${hero.nome}`;
        document.getElementById('hero-rating').innerText = hero.notaGeral.toFixed(2);
        document.getElementById('hero-goals').innerText = hero.gols;
        document.getElementById('hero-assists').innerText = hero.assistencias;
    }

    // --- RENDER FUNCTIONS ---
    function renderRankings(players) {
        const grid = document.getElementById('rankings-grid');
        grid.innerHTML = '';
        const term = document.getElementById('player-search').value.toLowerCase();
        const filtered = players.filter(p => p.nomeOriginal.toLowerCase().includes(term));

        const createBox = (title, key, unit, reverse=false, sourceData=filtered) => {
            const sorted = [...sourceData].sort((a,b) => reverse ? a[key]-b[key] : b[key]-a[key]);
            const top5 = sorted.slice(0, 5);
            let html = `<div class="glass-panel rounded-xl overflow-hidden flex flex-col h-full border border-white/5 hover:border-white/10 transition">
                <div class="p-4 border-b border-white/5 bg-white/5 flex justify-between items-center">
                    <h3 class="font-bold text-white text-xs uppercase tracking-wider">${title}</h3>
                </div>
                <div class="flex-1 p-2">`;
            top5.forEach((p, i) => {
                html += `<div class="rank-item rounded-lg" onclick="window.openPlayerModal('${p.nome}')">
                    <span class="rank-pos ${i<3?'rank-'+(i+1):''} w-8 text-center">${i+1}</span>
                    <div class="flex items-center gap-3 ml-2 flex-1">
                        <img src="${playerPhotos[p.nome]||''}" class="w-8 h-8 rounded-full object-cover border border-white/10" onerror="this.src='https://ui-avatars.com/api/?name=${p.nome}'">
                        <span class="text-sm text-white truncate w-32 font-medium">${p.nomeOriginal.split(' ')[0]}</span>
                    </div>
                    <span class="text-sm font-bold font-mono text-blue-400">${typeof p[key]==='number'?p[key].toFixed(key==='notaGeral'||key==='mediaGolsSofridos'?2:0):p[key]}${unit}</span>
                </div>`;
            });
            html += `</div><button onclick='window.openFullRanking("${title}", "${key}", ${reverse})' class="w-full py-3 text-xs font-bold text-gray-400 hover:text-white hover:bg-white/5 border-t border-white/5 transition uppercase tracking-wider">Ver Ranking Completo</button></div>`;
            return html;
        };

        grid.innerHTML += createBox('Nota Geral', 'notaGeral', '', false);
        grid.innerHTML += createBox('SELEÇÃO DA SEMANA', 'selectionCount', 'x', false);
        grid.innerHTML += createBox('Gols', 'gols', '', false);
        grid.innerHTML += createBox('Assistências', 'assistencias', '', false);
        grid.innerHTML += createBox('Participação (G+A)', 'ga', '', false);
        grid.innerHTML += createBox('Vitórias', 'vitorias', 'V', false);
        grid.innerHTML += createBox('Fominha (Jogos)', 'jogos', 'J', false);
        
        const gks = filtered.filter(p => p.mediaGolsSofridos !== null && p.jogosGoleiro >= 3);
        if(gks.length > 0) grid.innerHTML += createBox('Ranking Goleiros (Média Gols)', 'mediaGolsSofridos', '', true, gks);
        
        grid.innerHTML += createBox('Aproveitamento', 'aproveitamento', '%', false);
    }

    window.openFullRanking = (title, key, reverse) => {
        const players = allPlayersData; 
        const sorted = [...players].sort((a,b) => reverse ? a[key]-b[key] : b[key]-a[key]);
        let html = `<table class="w-full text-left text-sm text-gray-300">
            <thead class="text-xs uppercase bg-white/5 text-gray-400 sticky top-0 backdrop-blur-md"><tr><th class="p-4">#</th><th class="p-4">Jogador</th><th class="p-4 text-right">Valor</th></tr></thead>
            <tbody>`;
        sorted.forEach((p, i) => {
            html += `<tr class="border-b border-white/5 hover:bg-white/5 cursor-pointer transition" onclick="window.openPlayerModal('${p.nome}')">
                <td class="p-4 font-bold font-mono ${i<3?'text-yellow-500':''}">${i+1}</td>
                <td class="p-4 flex items-center gap-4">
                    <img src="${playerPhotos[p.nome]||''}" class="w-8 h-8 rounded-full object-cover" onerror="this.src='https://ui-avatars.com/api/?name=${p.nome}'">
                    <span class="font-medium text-white">${p.nomeOriginal}</span>
                </td>
                <td class="p-4 text-right font-mono font-bold text-blue-400">${typeof p[key]==='number'?p[key].toFixed(2):p[key]}</td>
            </tr>`;
        });
        html += `</tbody></table>`;
        document.getElementById('full-list-title').innerText = title;
        document.getElementById('full-list-content').innerHTML = html;
        const modal = document.getElementById('full-list-modal');
        modal.classList.remove('hidden'); modal.classList.add('flex');
    }

    function renderSelectionField(players) {
        const getBest = (pos, count) => players.filter(p => p.posicaoPref === pos).sort((a,b) => b.notaGeral - a.notaGeral).slice(0, count);
        const team = { ata: getBest('ata', 2), mei: getBest('mei', 1), ala: getBest('ala', 2), zag: getBest('zag', 1), gol: getBest('gol', 1) };
        const posStyles = {
            gol: ['bottom: 5%; left: 50%; transform: translateX(-50%)'],
            zag: ['bottom: 22%; left: 50%; transform: translateX(-50%)'],
            ala: ['bottom: 40%; left: 15%', 'bottom: 40%; right: 15%'],
            mei: ['top: 48%; left: 50%; transform: translate(-50%, -50%)'],
            ata: ['top: 18%; left: 30%', 'top: 18%; right: 30%']
        };
        let html = '';
        const renderP = (p, style) => `
            <div class="absolute flex flex-col items-center transition-all duration-300 hover:scale-110 cursor-pointer z-10 group" style="${style}" onclick="window.openPlayerModal('${p.nome}')">
                <div class="relative">
                    <img src="${playerPhotos[p.nome]||''}" class="w-14 h-14 rounded-full border-2 border-yellow-400 shadow-[0_0_20px_rgba(234,179,8,0.4)] object-cover bg-gray-900" onerror="this.src='https://ui-avatars.com/api/?name=${p.nome}'">
                    <div class="absolute -bottom-1 -right-1 bg-black/80 text-yellow-400 text-[10px] font-bold px-1.5 py-0.5 rounded border border-yellow-400/30 font-mono">${p.notaGeral.toFixed(1)}</div>
                </div>
                <div class="bg-black/60 backdrop-blur-sm px-2 py-0.5 rounded mt-1 text-[10px] text-white font-bold tracking-wider border border-white/10 shadow-lg truncate max-w-[80px] group-hover:bg-blue-600 transition-colors">${p.nomeOriginal.split(' ')[0]}</div>
            </div>`;
        if(team.gol[0]) html += renderP(team.gol[0], posStyles.gol[0]);
        if(team.zag[0]) html += renderP(team.zag[0], posStyles.zag[0]);
        team.ala.forEach((p, i) => html += renderP(p, posStyles.ala[i]));
        team.mei.forEach((p, i) => html += renderP(p, posStyles.mei[i]));
        team.ata.forEach((p, i) => html += renderP(p, posStyles.ata[i]));
        document.getElementById('pitch-players').innerHTML = html;
        const sel = document.getElementById('month-filter');
        document.getElementById('team-period-label').innerText = sel.options[sel.selectedIndex].text;
    }

    function renderSpecialRankings(players, matches) {
        // Garçom
        const garcom = [...players].sort((a,b) => b.assistencias - a.assistencias)[0];
        if(garcom) {
             document.getElementById('assist-leader-content').innerHTML = `
                <img src="${playerPhotos[garcom.nome]||''}" class="w-12 h-12 rounded-full border-2 border-yellow-500 object-cover shadow-lg">
                <div><div class="font-bold text-white text-sm">${garcom.nomeOriginal.split(' ')[0]}</div><div class="text-xs text-yellow-500 font-mono font-bold bg-yellow-500/10 px-1 rounded">${garcom.assistencias} ASSIST</div></div>`;
        }

        const gks = players.filter(p => p.mediaGolsSofridos !== null && p.jogosGoleiro >= 3).sort((a,b) => a.mediaGolsSofridos - b.mediaGolsSofridos);
        if(gks[0]) {
            document.getElementById('paredao-content').innerHTML = `
                <img src="${playerPhotos[gks[0].nome]||''}" class="w-12 h-12 rounded-full border-2 border-blue-500 object-cover shadow-lg">
                <div><div class="font-bold text-white text-sm">${gks[0].nomeOriginal.split(' ')[0]}</div><div class="text-xs text-blue-400 font-mono font-bold bg-blue-500/10 px-1 rounded">${gks[0].mediaGolsSofridos.toFixed(2)} Gols/J</div></div>`;
        }
        const topS = [...players].sort((a,b) => b.gols - a.gols)[0];
        if(topS) {
            document.getElementById('top-scorer-content').innerHTML = `
                <img src="${playerPhotos[topS.nome]||''}" class="w-12 h-12 rounded-full border-2 border-green-500 object-cover shadow-lg">
                <div><div class="font-bold text-white text-sm">${topS.nomeOriginal.split(' ')[0]}</div><div class="text-xs text-green-400 font-mono font-bold bg-green-500/10 px-1 rounded">${topS.gols} GOLS</div></div>`;
        }
    }

    function renderHall(players) {
        const topPlayers = players.filter(p => p.conquistas.length > 0 || p.nivel === 'Lenda').sort((a,b) => b.conquistas.length - a.conquistas.length);
        const html = topPlayers.map(p => `
            <div class="glass-panel p-6 rounded-xl flex flex-col items-center relative overflow-hidden group hover:border-white/20 transition cursor-pointer" onclick="window.openPlayerModal('${p.nome}')">
                <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-white/20 to-transparent"></div>
                <div class="absolute top-2 right-2 bg-yellow-500/20 text-yellow-400 text-xs px-2 py-1 rounded-full font-bold border border-yellow-500/30 shadow-[0_0_10px_rgba(234,179,8,0.2)]">${p.conquistas.length} <i class="fas fa-trophy ml-1"></i></div>
                <img src="${playerPhotos[p.nome]||''}" class="w-20 h-20 rounded-full border-2 border-white/10 object-cover mb-3 shadow-xl group-hover:scale-105 transition-transform" onerror="this.src='https://ui-avatars.com/api/?name=${p.nome}'">
                <h3 class="font-bold text-lg text-white mb-1">${p.nomeOriginal.split(' ')[0]}</h3>
                <div class="flex flex-wrap justify-center gap-1 w-full mt-2">
                    ${p.conquistas.slice(0, 4).map(c => `<span class="w-2 h-2 rounded-full bg-${c.rarity === 'lendario' ? 'yellow-500' : c.rarity === 'mitico' ? 'purple-500' : 'blue-400'}" title="${c.nome}"></span>`).join('')}
                </div>
            </div>
        `).join('');
        document.getElementById('hall-grid').innerHTML = html || '<p class="text-gray-500 col-span-3 text-center py-8">Ainda não há conquistas registradas nesta temporada.</p>';
    }
    
    // --- FUN FACTS (EXPANDED TO 15) ---
    function renderFunFacts(players, matches) {
        const container = document.getElementById('curiosities-grid');
        if(!container) return;
        container.innerHTML = '';

        const facts = [];

        // 1. Atuação de Gala (Maior Nota)
        const bestMatch = matches.filter(m => m.jogoAconteceu).sort((a,b) => b.notaPartida - a.notaPartida)[0];
        if(bestMatch) facts.push({ icon: 'fa-star', color: 'text-yellow-400', title: 'Atuação de Gala', text: `Maior nota: <strong>${bestMatch.notaPartida.toFixed(1)}</strong> por <strong>${bestMatch.nomeRaw.split(' ')[0]}</strong> em ${bestMatch.dataJogo}.` });

        // 2. Chuva de Gols (Dia com mais gols)
        const goalsByDate = {};
        matches.filter(m=>m.jogoAconteceu).forEach(m => goalsByDate[m.dataJogo] = (goalsByDate[m.dataJogo] || 0) + m.gols);
        const topDate = Object.keys(goalsByDate).sort((a,b) => goalsByDate[b] - goalsByDate[a])[0];
        if(topDate) facts.push({ icon: 'fa-cloud-showers-heavy', color: 'text-blue-400', title: 'Chuva de Gols', text: `O dia <strong>${topDate}</strong> teve o recorde de <strong>${goalsByDate[topDate]}</strong> gols marcados.` });

        // 3. Amuleto da Sorte (Maior % vitória com min 5 jogos)
        const lucky = players.filter(p => p.jogos >= 5).sort((a,b) => b.aproveitamento - a.aproveitamento)[0];
        if(lucky) facts.push({ icon: 'fa-gem', color: 'text-purple-400', title: 'Amuleto da Sorte', text: `<strong>${lucky.nomeOriginal.split(' ')[0]}</strong> tem o melhor aproveitamento (${lucky.aproveitamento.toFixed(0)}%) com min. 5 jogos.` });

        // 4. Pé Frio (Menor % vitória com min 5 jogos)
        const unlucky = players.filter(p => p.jogos >= 5).sort((a,b) => a.aproveitamento - b.aproveitamento)[0];
        if(unlucky) facts.push({ icon: 'fa-snowflake', color: 'text-cyan-300', title: 'Pé Frio', text: `<strong>${unlucky.nomeOriginal.split(' ')[0]}</strong> tem o menor aproveitamento (${unlucky.aproveitamento.toFixed(0)}%) até agora.` });

        // 5. Zagueiro Artilheiro
        const zagArtilheiro = players.filter(p => p.posicaoPref === 'zag').sort((a,b) => b.gols - a.gols)[0];
        if(zagArtilheiro && zagArtilheiro.gols > 0) facts.push({ icon: 'fa-shield-alt', color: 'text-green-400', title: 'Zagueiro Artilheiro', text: `<strong>${zagArtilheiro.nomeOriginal.split(' ')[0]}</strong> é o defensor com mais gols (${zagArtilheiro.gols}).` });

        // 6. Goleiro Garçom
        const gkGarcom = players.filter(p => p.posicaoPref === 'gol').sort((a,b) => b.assistencias - a.assistencias)[0];
        if(gkGarcom && gkGarcom.assistencias > 0) facts.push({ icon: 'fa-hands', color: 'text-yellow-300', title: 'Goleiro Garçom', text: `<strong>${gkGarcom.nomeOriginal.split(' ')[0]}</strong> já deu <strong>${gkGarcom.assistencias}</strong> assistências jogando no gol.` });

        // 7. Máquina de Gols (Média)
        const machine = players.filter(p => p.jogos >= 3).sort((a,b) => (b.gols/b.jogos) - (a.gols/a.jogos))[0];
        if(machine) facts.push({ icon: 'fa-robot', color: 'text-red-500', title: 'Máquina de Gols', text: `<strong>${machine.nomeOriginal.split(' ')[0]}</strong> tem a melhor média: ${(machine.gols/machine.jogos).toFixed(2)} gols por jogo.` });

        // 8. Rei da Regularidade (Menor variação de nota, min 5 jogos)
        const regular = players.filter(p => p.jogos >= 5).map(p => ({...p, var: Math.max(...p.partidas.map(m=>m.notaPartida)) - Math.min(...p.partidas.map(m=>m.notaPartida))})).sort((a,b) => a.var - b.var)[0];
        if(regular) facts.push({ icon: 'fa-balance-scale', color: 'text-gray-300', title: 'Rei da Regularidade', text: `<strong>${regular.nomeOriginal.split(' ')[0]}</strong> oscila pouco. Diferença de apenas ${regular.var.toFixed(1)} entre sua melhor e pior nota.` });

        // 9. Montanha Russa (Maior variação)
        const rollercoaster = players.filter(p => p.jogos >= 5).map(p => ({...p, var: Math.max(...p.partidas.map(m=>m.notaPartida)) - Math.min(...p.partidas.map(m=>m.notaPartida))})).sort((a,b) => b.var - a.var)[0];
        if(rollercoaster) facts.push({ icon: 'fa-wave-square', color: 'text-orange-400', title: 'Montanha Russa', text: `<strong>${rollercoaster.nomeOriginal.split(' ')[0]}</strong> é imprevisível! Variação de ${rollercoaster.var.toFixed(1)} pontos entre jogos.` });

        // 10. O "Inimigo" do Gol (Atacante com menos gols, min 5 jogos)
        const shyStriker = players.filter(p => p.posicaoPref === 'ata' && p.jogos >= 5).sort((a,b) => (a.gols/a.jogos) - (b.gols/b.jogos))[0];
        if(shyStriker) facts.push({ icon: 'fa-ban', color: 'text-red-300', title: 'Inimigo do Gol', text: `<strong>${shyStriker.nomeOriginal.split(' ')[0]}</strong> é o atacante com menor média de gols (${(shyStriker.gols/shyStriker.jogos).toFixed(2)}/jogo).` });

        // 11. Melhor Estreia
        // Find first match for each player
        const debuts = players.map(p => {
            const firstMatch = p.partidas.sort((a,b) => new Date(a.dataJogo.split('/').reverse().join('-')) - new Date(b.dataJogo.split('/').reverse().join('-')))[0];
            return { name: p.nomeOriginal, note: firstMatch.notaPartida, date: firstMatch.dataJogo };
        }).sort((a,b) => b.note - a.note)[0];
        if(debuts) facts.push({ icon: 'fa-rocket', color: 'text-pink-400', title: 'Estreia de Ouro', text: `<strong>${debuts.name.split(' ')[0]}</strong> teve a melhor estreia registrada: Nota <strong>${debuts.note.toFixed(1)}</strong> em ${debuts.date}.` });

        // 12. Artilheiro de Um Dia (Mais gols num jogo só)
        const oneDayKing = matches.filter(m=>m.jogoAconteceu).sort((a,b) => b.gols - a.gols)[0];
        if(oneDayKing) facts.push({ icon: 'fa-crown', color: 'text-yellow-500', title: 'Artilheiro de Um Dia', text: `<strong>${oneDayKing.nomeRaw.split(' ')[0]}</strong> fez história com <strong>${oneDayKing.gols} gols</strong> em uma única partida.` });

        // 13. Garçom de Um Dia
        const oneDayWaiter = matches.filter(m=>m.jogoAconteceu).sort((a,b) => b.assistencias - a.assistencias)[0];
        if(oneDayWaiter) facts.push({ icon: 'fa-tray', color: 'text-blue-300', title: 'Garçom de Um Dia', text: `<strong>${oneDayWaiter.nomeRaw.split(' ')[0]}</strong> serviu <strong>${oneDayWaiter.assistencias} assistências</strong> em um único jogo.` });

        // 14. O "Participativo" (Gols+Assist / Jogos)
        const involved = players.filter(p => p.jogos >= 3).sort((a,b) => (b.ga/b.jogos) - (a.ga/a.jogos))[0];
        if(involved) facts.push({ icon: 'fa-handshake', color: 'text-teal-400', title: 'O Onipresente', text: `<strong>${involved.nomeOriginal.split(' ')[0]}</strong> participa de ${(involved.ga/involved.jogos).toFixed(1)} gols por jogo (Gols+Assist).` });

        // 15. Muralha (Menor média de gols sofridos, min 3 jogos no gol)
        const wall = players.filter(p => p.jogosGoleiro >= 3).sort((a,b) => a.mediaGolsSofridos - b.mediaGolsSofridos)[0];
        if(wall) facts.push({ icon: 'fa-brick', color: 'text-gray-400', title: 'A Muralha', text: `<strong>${wall.nomeOriginal.split(' ')[0]}</strong> é o goleiro mais difícil de bater: média de ${wall.mediaGolsSofridos.toFixed(1)} gols sofridos.` });

        facts.forEach(f => {
            container.innerHTML += `
                <div class="glass-panel p-5 rounded-xl border border-white/5 flex items-start gap-4 hover:bg-white/5 transition">
                    <div class="p-3 rounded-full bg-white/5 ${f.color} text-xl min-w-[3rem] text-center flex items-center justify-center"><i class="fas ${f.icon}"></i></div>
                    <div>
                        <h4 class="font-bold text-white text-sm uppercase mb-1">${f.title}</h4>
                        <p class="text-xs text-gray-400 leading-relaxed">${f.text}</p>
                    </div>
                </div>
            `;
        });
    }

    function renderStatsCharts(players, matches) {
        const createChart = (id, l, d, c) => {
            const ctx = document.getElementById(id); if(!ctx) return;
            if(chartInstances[id]) chartInstances[id].destroy();
            const s = d.sort((a,b)=>b.v-a.v).slice(0,10);
            chartInstances[id] = new Chart(ctx, {
                type: 'bar',
                data: { labels: s.map(x=>x.n), datasets: [{label:l, data:s.map(x=>x.v), backgroundColor:c, borderRadius:4}] },
                options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}, title:{display:true, text:l, color:'#fff', font:{family:'Rajdhani', size:16}}}, scales:{y:{grid:{color:'rgba(255,255,255,0.05)'}, ticks:{color:'#94a3b8'}}, x:{grid:{display:false}, ticks:{color:'#94a3b8'}}} }
            });
        };
        createChart('chart-gols', 'Top Artilheiros', players.map(p=>({n:p.nomeOriginal.split(' ')[0], v:p.gols})), '#4ade80');
        createChart('chart-assists', 'Top Assistências', players.map(p=>({n:p.nomeOriginal.split(' ')[0], v:p.assistencias})), '#facc15');
        createChart('chart-games', 'Mais Jogos', players.map(p=>({n:p.nomeOriginal.split(' ')[0], v:p.jogos})), '#60a5fa');

        const ctxGroup = document.getElementById('chart-group-goals');
        if(ctxGroup) {
            if(chartInstances['group']) chartInstances['group'].destroy();
            const months = {};
            matches.filter(m=>m.jogoAconteceu).forEach(m => { const k = m.dataJogo.substring(3); months[k] = (months[k] || 0) + m.gols; });
            const labels = Object.keys(months).sort((a,b) => new Date(a.split('/').reverse().join('-')) - new Date(b.split('/').reverse().join('-')));
            chartInstances['group'] = new Chart(ctxGroup, {
                type: 'line',
                data: { labels: labels, datasets: [{ label: 'Gols do Grupo', data: labels.map(l=>months[l]), borderColor:'#f472b6', backgroundColor:'rgba(244,114,182,0.1)', fill:true, tension:0.4 }] },
                options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}, title:{display:true, text:'Evolução de Gols (Mensal)', color:'#fff'}}, scales:{y:{grid:{color:'rgba(255,255,255,0.05)'}}, x:{ticks:{color:'#94a3b8'}}} }
            });
        }
    }

    // --- MODAL JOGADOR ---
    window.openPlayerModal = (name) => {
        const p = allPlayersData.find(pl => pl.nome === name);
        if(!p) return;
        const stats = p.fifa;
        const container = document.getElementById('modal-card-container');
        
        // Reset classes e aplica a nova baseada no OVR calculado
        container.className = 'fut-card-container relative group';
        container.classList.add(stats.cssClass); 
        
        document.getElementById('card-ovr').innerText = stats.ovr;
        document.getElementById('card-pos').innerText = p.posicaoPref.substring(0,3).toUpperCase();
        document.getElementById('card-img').src = playerPhotos[p.nome] || '';
        document.getElementById('card-name').innerText = p.nomeOriginal.split(' ')[0];
        
        document.getElementById('stat-pac').innerText = stats.pac; 
        document.getElementById('stat-sho').innerText = stats.sho;
        document.getElementById('stat-pas').innerText = stats.pas; 
        document.getElementById('stat-def').innerText = stats.def;
        document.getElementById('stat-phy').innerText = stats.phy; 
        
        // JOG agora é o atributo final da carta (sexto status), mantendo a lógica visual do FIFA
        // Mas no seu caso, 'JOG' (Jogos) é um dado interessante para manter ali.
        document.getElementById('stat-jog').innerText = p.jogos;

        document.getElementById('detail-name').innerText = p.nomeOriginal;
        document.getElementById('detail-level').innerText = p.nivel;
        document.getElementById('detail-media').innerText = p.notaGeral.toFixed(2);
        document.getElementById('detail-gols').innerText = p.gols;
        document.getElementById('detail-assist').innerText = p.assistencias;
        document.getElementById('detail-wins').innerText = p.vitorias;
        document.getElementById('detail-history').innerHTML = p.partidas.slice().reverse().slice(0, 5).map(m => `<div class="flex justify-between text-xs p-3 bg-white/5 rounded mb-1 border border-white/5"><span class="text-gray-400 font-mono">${m.dataJogo}</span><div class="flex gap-2">${m.gols>0?`<span class="bg-green-500/20 text-green-400 px-1 rounded">${m.gols}G</span>`:''} <span class="font-bold text-white">${m.notaPartida.toFixed(1)}</span></div></div>`).join('');
        
        const badgeContainer = document.getElementById('detail-badges');
        if(p.conquistas && p.conquistas.length > 0) {
            badgeContainer.innerHTML = p.conquistas.map(c => `<span class="achievement-badge rarity-${c.rarity}" title="${c.desc}"><i class="fas ${c.icon} mr-1"></i>${c.nome}</span>`).join('');
        } else badgeContainer.innerHTML = '<span class="text-xs text-gray-600 italic">Nenhuma conquista ainda.</span>';

        // Chart Evo
        const ctx = document.getElementById('player-evo-chart');
        if(ctx) {
            if(chartInstances['playerEvo']) chartInstances['playerEvo'].destroy();
            const matches = p.partidas.slice(-10);
            chartInstances['playerEvo'] = new Chart(ctx, {
                type: 'line',
                data: { labels: matches.map(m => m.dataJogo.substring(0, 5)), datasets: [{ label: 'Nota', data: matches.map(m => m.notaPartida), borderColor: '#3b82f6', backgroundColor: 'rgba(59, 130, 246, 0.1)', borderWidth: 2, pointRadius: 3, fill: true, tension: 0.3 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { min: 4, max: 10, grid: { color: 'rgba(255,255,255,0.05)' }, ticks:{ color:'#aaa' } }, x: { display: false } } }
            });
        }

        const modal = document.getElementById('player-modal');
        modal.classList.remove('hidden'); modal.classList.add('flex');
    };

    window.openMatchModal = (date) => {
        const matches = allMatchesData.filter(m => m.dataJogo === date);
        if(!matches.length) return;

        // Check if game happened
        const happened = matches.some(m => m.jogoAconteceu);

        // Calculate scores only if happened
        let scoreA = 0, scoreB = 0;
        let boca = matches.filter(m => m.time.toUpperCase().includes('BOCA'));
        let river = matches.filter(m => m.time.toUpperCase().includes('RIVER'));
        
        if (happened) {
            scoreA = boca.reduce((a,b) => a + b.gols, 0);
            scoreB = river.reduce((a,b) => a + b.gols, 0);
        }

        document.getElementById('match-date').innerText = `RESUMO: ${date}`;
        document.getElementById('score-a').innerText = happened ? scoreA : '-';
        document.getElementById('score-b').innerText = happened ? scoreB : '-';

        const renderList = (team) => team.map(p => `
            <div class="flex justify-between items-center p-2 bg-white/5 rounded mb-1 border border-white/5 hover:bg-white/10 transition" style="cursor: pointer;" onclick="window.openPlayerModal('${p.nome}')">
                <div class="flex items-center gap-2 text-sm text-gray-300">
                    <span class="text-xs opacity-50 w-4">${p.posicao.toUpperCase().substring(0,1)}</span>
                    <span class="font-medium text-white">${p.nomeRaw.split(' ')[0]}</span>
                    ${p.isGoleiro ? '<span class="badge badge-gk">GK</span>' : ''}
                    ${happened && p.gols > 0 ? `<span class="badge badge-gol">${p.gols}G</span>` : ''}
                    ${happened && p.assistencias > 0 ? `<span class="badge badge-ass">${p.assistencias}A</span>` : ''}
                </div>
                ${happened ? `<div class="font-mono font-bold text-yellow-400 text-xs">${p.notaPartida.toFixed(1)}</div>` : ''}
            </div>
        `).join('');

        document.getElementById('list-boca').innerHTML = renderList(boca);
        document.getElementById('list-river').innerHTML = renderList(river);

        // Selection (Only if happened)
        let html = '';
        if (happened) {
            const getPos = (pos, count, exclude) => matches.filter(p => p.posicao === pos && !exclude.includes(p)).sort((a,b) => b.notaPartida - a.notaPartida).slice(0, count);
            let sel = [];
            const team = { gol: getPos('gol',1,sel), zag: getPos('zag',1,sel), ala: getPos('ala',2,sel), mei: getPos('mei',1,sel), ata: getPos('ata',2,sel) };
            
            const renderP = (p, style) => `
                <div class="absolute flex flex-col items-center transform -translate-x-1/2 z-10" style="${style}" onclick="window.openPlayerModal('${p.nome}')">
                    <img src="${playerPhotos[p.nome]||''}" class="w-10 h-10 rounded-full border-2 border-yellow-400 shadow-lg bg-black object-cover" onerror="this.src='https://ui-avatars.com/api/?name=${p.nome}'">
                    <div class="bg-black/80 px-2 rounded mt-1 text-[9px] text-white font-bold truncate max-w-[60px] text-center border border-white/20">${p.nomeRaw.split(' ')[0]}</div>
                    <div class="text-yellow-400 text-[9px] font-bold -mt-7 ml-6 bg-black/80 px-1 rounded border border-yellow-500/30">${p.notaPartida.toFixed(1)}</div>
                </div>`;
            
            if(team.gol[0]) html += renderP(team.gol[0], 'bottom: 5%; left: 50%');
            if(team.zag[0]) html += renderP(team.zag[0], 'bottom: 22%; left: 50%');
            team.ala.forEach((p,i) => html += renderP(p, `bottom: 40%; ${i===0?'left: 15%':'right: 15%'}`));
            team.mei.forEach((p,i) => html += renderP(p, 'top: 48%; left: 50%'));
            team.ata.forEach((p,i) => html += renderP(p, `top: 18%; ${i===0?'left: 30%':'right: 30%'}`));
        } else {
            html = '<div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-gray-400 text-sm font-bold bg-black/50 px-4 py-2 rounded border border-white/10">AGUARDANDO INÍCIO DA PARTIDA</div>';
        }
        
        document.getElementById('match-team-display').innerHTML = html;
        const modal = document.getElementById('match-modal');
        modal.classList.remove('hidden'); modal.classList.add('flex');
    }

    function renderHistory(matches) {
        const div = document.getElementById('matches-list');
        const dates = [...new Set(matches.map(m => m.dataJogo))].sort((a,b) => new Date(b.split('/').reverse().join('-')) - new Date(a.split('/').reverse().join('-')));
        div.innerHTML = dates.map(d => {
            const ms = matches.filter(m => m.dataJogo === d);
            const happened = ms.some(x => x.jogoAconteceu);
            const ga = ms.filter(x => x.time.toUpperCase().includes('BOCA')).reduce((a,b)=>a+b.gols,0);
            const gb = ms.filter(x => x.time.toUpperCase().includes('RIVER')).reduce((a,b)=>a+b.gols,0);
            return `<div class="glass-panel p-4 rounded-xl flex justify-between items-center border border-white/5 hover:bg-white/5 transition cursor-pointer" onclick="window.openMatchModal('${d}')">
                <span class="text-gray-400 text-sm font-mono">${d}</span>
                ${happened ? `<span class="font-bold text-white text-xl font-fifa"><span class="text-blue-400">BOCA ${ga}</span> <span class="text-gray-600 text-sm mx-2">VS</span> <span class="text-red-400">${gb} RIVER</span></span>` : '<span class="text-xs bg-white/10 px-2 py-1 rounded text-gray-400">AGENDADO</span>'}
            </div>`;
        }).join('');
    }

    function renderDraftList(players) {
        const list = document.getElementById('draft-list');
        list.innerHTML = players.sort((a,b) => a.nomeOriginal.localeCompare(b.nomeOriginal)).map(p => `
            <div class="flex items-center justify-between p-2 hover:bg-white/5 rounded cursor-pointer group transition" onclick="window.toggleDraftSelection(this)">
                <div class="flex items-center gap-3">
                    <div class="w-4 h-4 rounded border border-gray-600 flex items-center justify-center draft-chk-box text-xs text-transparent transition">✓</div>
                    <input type="checkbox" value="${p.nome}" class="draft-chk hidden" data-pos="${p.posicaoPref}">
                    <img src="${playerPhotos[p.nome] || ''}" class="w-6 h-6 rounded-full object-cover opacity-70 group-hover:opacity-100">
                    <div class="flex flex-col">
                        <span class="text-sm text-gray-400 group-hover:text-white transition">${p.nomeOriginal}</span>
                        <span class="text-[10px] text-gray-600 uppercase">${p.posicaoPref}</span>
                    </div>
                </div>
                <span class="text-xs font-bold text-gray-600 group-hover:text-yellow-500 font-mono transition">${p.fifa.ovr}</span>
            </div>
        `).join('');
    }

    window.toggleDraftSelection = (div) => {
        const chk = div.querySelector('.draft-chk');
        const box = div.querySelector('.draft-chk-box');
        chk.checked = !chk.checked;
        if(chk.checked) {
            box.classList.remove('text-transparent', 'border-gray-600');
            box.classList.add('bg-blue-500', 'border-blue-500', 'text-white');
            div.classList.add('bg-white/10');
        } else {
            box.classList.add('text-transparent', 'border-gray-600');
            box.classList.remove('bg-blue-500', 'border-blue-500', 'text-white');
            div.classList.remove('bg-white/10');
        }
        document.getElementById('selected-count').innerText = `${document.querySelectorAll('.draft-chk:checked').length} JOG`;
    }

    function generateTeams() {
        const selectedEl = Array.from(document.querySelectorAll('.draft-chk:checked'));
        if(selectedEl.length < 2) return alert('Selecione ao menos 2 jogadores');
        
        const selectedNames = selectedEl.map(c => c.value);
        const pool = allPlayersData.filter(p => selectedNames.includes(p.nome));

        // Separate GKs
        const gks = pool.filter(p => p.posicaoPref === 'gol').sort((a,b) => b.fifa.ovr - a.fifa.ovr);
        const outfield = pool.filter(p => p.posicaoPref !== 'gol').sort((a,b) => b.fifa.ovr - a.fifa.ovr);

        const teamA = [], teamB = [];

        // Distribute GKs (1 for A, 1 for B)
        if(gks.length > 0) teamA.push(gks[0]);
        if(gks.length > 1) teamB.push(gks[1]);
        // If more than 2 GKs, add remainder to outfield pool to be distributed
        if(gks.length > 2) outfield.push(...gks.slice(2));
        
        // Distribute Outfield (Snake)
        // Since A got best GK, maybe start snake with B? Let's keep simple snake: A, B, B, A...
        outfield.forEach((p, i) => { 
            // Snake Logic: 0->A, 1->B, 2->B, 3->A, 4->A, 5->B...
            if (i % 4 === 0 || i % 4 === 3) teamB.push(p); // Reversed logic to balance GK advantage? 
            else teamA.push(p); 
        });

        const calcStats = (team) => ({ ovr: (team.reduce((a,p)=>a+p.fifa.ovr,0)/team.length).toFixed(1), goals: team.reduce((a,p)=>a+p.gols,0), xp: team.reduce((a,p)=>a+p.jogos,0) });
        const sa = calcStats(teamA), sb = calcStats(teamB);
        
        const renderT = (t) => t.map(p => `
            <div class="flex justify-between text-sm py-1.5 border-b border-white/5 text-gray-300">
                <div class="flex items-center gap-2">
                    ${p.posicaoPref === 'gol' ? '<span class="text-[10px] bg-yellow-500/20 text-yellow-500 px-1 rounded">GK</span>' : ''}
                    <span>${p.nomeOriginal}</span>
                </div>
                <span class="text-yellow-500 font-bold font-mono">${p.fifa.ovr}</span>
            </div>`).join('');
            
        document.getElementById('list-team-a').innerHTML = renderT(teamA);
        document.getElementById('list-team-b').innerHTML = renderT(teamB);
        document.getElementById('stats-team-a').innerText = `OVR: ${sa.ovr}`;
        document.getElementById('stats-team-b').innerText = `OVR: ${sb.ovr}`;
        const diff = parseFloat(sa.ovr) - parseFloat(sb.ovr);
        let msg = Math.abs(diff) < 2 ? "Confronto Equilibrado. A diferença técnica é mínima." : `Favorito: ${diff > 0 ? 'Time A' : 'Time B'} (+${Math.abs(diff).toFixed(1)} OVR).`;
        document.getElementById('verdict-text').innerText = msg;
        document.getElementById('verdict-panel').classList.remove('hidden');
        document.getElementById('teams-container').classList.remove('hidden');
        document.getElementById('teams-container').classList.add('grid');
    }

    // --- COMPARISON TOOL ---
    function setupComparisonTool() {
        const p1 = document.getElementById('p1-select');
        const p2 = document.getElementById('p2-select');
        if(p1.options.length > 0) return; // Already setup
        
        const opts = '<option value="">Selecione...</option>' + allPlayersData.sort((a,b)=>a.nomeOriginal.localeCompare(b.nomeOriginal)).map(p=>`<option value="${p.nome}">${p.nomeOriginal}</option>`).join('');
        p1.innerHTML = opts; p2.innerHTML = opts;

        const compare = () => {
            const pl1 = allPlayersData.find(p=>p.nome === p1.value);
            const pl2 = allPlayersData.find(p=>p.nome === p2.value);
            const div = document.getElementById('comparison-content');
            const radarContainer = document.getElementById('radar-container');
            
            if(!pl1 || !pl2) { 
                div.innerHTML = '<div class="text-center text-gray-500 col-span-3">Selecione dois jogadores.</div>'; 
                radarContainer.classList.add('hidden');
                return; 
            }

            radarContainer.classList.remove('hidden');
            radarContainer.classList.add('flex');

            const renderStats = (l, v1, v2) => `
                <div class="text-right font-bold ${v1>v2?'text-green-400':'text-gray-400'} text-xl">${v1}</div>
                <div class="text-center text-xs text-gray-500 uppercase tracking-widest mt-1">${l}</div>
                <div class="text-left font-bold ${v2>v1?'text-green-400':'text-gray-400'} text-xl">${v2}</div>
            `;

            div.innerHTML = `
                <div class="flex flex-col items-center animate-slide-in">
                    <img src="${playerPhotos[pl1.nome]||''}" class="w-32 h-32 rounded-full object-cover border-4 border-blue-500 mb-4 shadow-[0_0_20px_blue]">
                    <h3 class="font-bold text-2xl text-white font-fifa uppercase">${pl1.nomeOriginal.split(' ')[0]}</h3>
                    <div class="text-4xl font-fifa font-bold text-yellow-400 mt-2">${pl1.fifa.ovr}</div>
                </div>
                <div class="space-y-4 bg-white/5 p-6 rounded-xl border border-white/10">
                    <div class="grid grid-cols-3 gap-4 border-b border-white/5 pb-2">${renderStats('JOGOS', pl1.jogos, pl2.jogos)}</div>
                    <div class="grid grid-cols-3 gap-4 border-b border-white/5 pb-2">${renderStats('GOLS', pl1.gols, pl2.gols)}</div>
                    <div class="grid grid-cols-3 gap-4 border-b border-white/5 pb-2">${renderStats('ASSIST', pl1.assistencias, pl2.assistencias)}</div>
                    <div class="grid grid-cols-3 gap-4 border-b border-white/5 pb-2">${renderStats('NOTA', pl1.notaGeral.toFixed(2), pl2.notaGeral.toFixed(2))}</div>
                    <div class="grid grid-cols-3 gap-4 pb-2">${renderStats('VITÓRIAS', pl1.vitorias, pl2.vitorias)}</div>
                </div>
                <div class="flex flex-col items-center animate-slide-in">
                    <img src="${playerPhotos[pl2.nome]||''}" class="w-32 h-32 rounded-full object-cover border-4 border-red-500 mb-4 shadow-[0_0_20px_red]">
                    <h3 class="font-bold text-2xl text-white font-fifa uppercase">${pl2.nomeOriginal.split(' ')[0]}</h3>
                    <div class="text-4xl font-fifa font-bold text-yellow-400 mt-2">${pl2.fifa.ovr}</div>
                </div>
            `;

            const ctxRadar = document.getElementById('radar-chart');
            if(ctxRadar && Chart) {
                if(chartInstances['radar']) chartInstances['radar'].destroy();
                chartInstances['radar'] = new Chart(ctxRadar, {
                    type: 'radar',
                    data: {
                        labels: ['PAC', 'SHO', 'PAS', 'DEF', 'PHY', 'TEC'],
                        datasets: [
                            { label: pl1.nomeOriginal.split(' ')[0], data: [pl1.fifa.pac, pl1.fifa.sho, pl1.fifa.pas, pl1.fifa.def, pl1.fifa.phy, (pl1.notaGeral*10)], borderColor: '#3b82f6', backgroundColor: 'rgba(59, 130, 246, 0.2)', pointBackgroundColor: '#3b82f6' },
                            { label: pl2.nomeOriginal.split(' ')[0], data: [pl2.fifa.pac, pl2.fifa.sho, pl2.fifa.pas, pl2.fifa.def, pl2.fifa.phy, (pl2.notaGeral*10)], borderColor: '#ef4444', backgroundColor: 'rgba(239, 68, 68, 0.2)', pointBackgroundColor: '#ef4444' }
                        ]
                    },
                    options: {
                        maintainAspectRatio: false,
                        scales: { r: { grid: { color: 'rgba(255,255,255,0.1)' }, pointLabels: { color: '#fff', font: { size: 10, family: 'Rajdhani' } }, ticks: { display: false, backdropColor: 'transparent' }, angleLines: { color: 'rgba(255,255,255,0.1)' }, min: 0, max: 100 } },
                        plugins: { legend: { labels: { color: '#fff', font: { family: 'Inter' } } } }
                    }
                });
            }
        };
        p1.onchange = compare; p2.onchange = compare;
    }

    initData();
});
</script>
</script>
